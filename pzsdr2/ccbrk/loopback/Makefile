# The related system_top.hdf file must be symlinked or copied over to build.
#
# Also, this requires at least vivado-2016.2 for the xsct options to work.

SOURCES := $(wildcard *.c)
EXEC = loopback

all: $(EXEC)

$(EXEC): system_top.hdf
	@mkdir -p sdk
	@echo 'sdk setws sdk' > sdk/sdk.tcl
	@echo 'sdk createhw -name hw -hwspec system_top.hdf' >> sdk/sdk.tcl
	@echo 'sdk createbsp -name bsp -hwproject hw -proc ps7_cortexa9_0 -os standalone' >> sdk/sdk.tcl
	@echo 'sdk createapp -name $(EXEC) -hwproject hw -proc ps7_cortexa9_0 -os standalone -lang C -app "Empty Application" -bsp bsp' >> sdk/sdk.tcl
	@echo 'exit' >> sdk/sdk.tcl
	@xsct -no-ini -quiet sdk/sdk.tcl
	@patch -p0 < ../../u-boot-elf-2015.2.patch
	@cp -R $(SOURCES) "sdk/$(EXEC)/src/"
	@echo 'sdk setws sdk' > sdk/sdk.tcl
	@echo 'sdk build_project -name $(EXEC)' >> sdk/sdk.tcl
	@echo 'exit' >> sdk/sdk.tcl
	@xsct -no-ini -quiet sdk/sdk.tcl
	@rm -rf .Xil *.log

clean:
	@rm -rf sdk
